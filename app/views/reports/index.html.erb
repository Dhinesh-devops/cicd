<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/css/bootstrap-datepicker.min.css" integrity="sha512-34s5cpvaNG3BknEWSuOncX28vz97bRI59UnVtEEpFX536A7BtZSJHsDyFoCl8S7Dt2TPzcrCEoHBGeM4SUBDBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<div class="main-panel">
  <div class="content-wrapper">
    <div class="row">
      <div class="col-md-12 grid-margin stretch-card">
        <div class="card">
          <div class="card-body" id="report_data_card">
            <div class="row">
              <div class="col-md-2"><p class="card-title">Reports</p></div>
              <div class="col-md-10">
                <div class="row" id="report-filters">
                  <div class="col-md-2 pr-0 pl-0">
                    <div class="form-group">
                      <select class="form-select form-control form-control-sm" id="reportCategory">
                        <option value="">Category</option>
                        <option value="scanned">Stock</option>
                        <option value="missed">Missed</option>
                        <option value="sold">Sold</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="input-daterange input-group" id="datepicker">
                      <input type="text" class="input-sm form-control form-control-sm text-left" name="start" placeholder="Start Date" id="reportStartDate" />
                      <div class="input-group-append">
                        <span class="input-group-text"><i class="ti-calendar"></i></span>
                      </div>
                      <span class="input-group-addon">to</span>
                      <input type="text" class="input-sm form-control form-control-sm text-left" name="end" placeholder="End Date" id="reportEndDate" />
                      <div class="input-group-append">
                        <span class="input-group-text"><i class="ti-calendar"></i></span>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4 pl-0">
                    <button class="btn btn-primary" id="applyFilters">Apply</button>
                    <button class="btn btn-success" id="exportData" style="float: right;">Export</button>
                  </div>
                </div>
              </div>
            </div>
            </div>
            <div class="row">
              <div class="col-12">
                <div class="table-responsive">
                  <table id="report_data" class="display expandable-table dataTable" style="width:100%">
                    <thead>
                      <tr>
                        <th>S.No.</th>
                        <th>Plant</th>
                        <th>Retek Group</th>
                        <th>Retek Dept.</th>
                        <th>Retek Class</th>
                        <th>Retek Subclass</th>
                        <th>Season</th>
                        <th>EAN</th>
                        <th>RFID Number</th>
                        <th>Size</th>
                        <th>Style Code</th>
                        <th>St.Loc</th>
                        <th>Variant</th>
                        <th>MRP</th>
                        <th>SOH blocked stock</th>
                        <th>SOH without blocked stock</th>
                        <th>SOH Qty.</th>
                        <th>Value</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                  </table>
                </div>
              </div>
            </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/js/bootstrap-datepicker.min.js" integrity="sha512-LsnSViqQyaXpD4mBBdRYeP6sRwJiJveh2ZIbW41EBrNmKxgr/LFZIiWT6yr+nycvhvauz8c2nYMhrP80YhG7Cw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
$(document).ready(function(){
  var category = "";
  var start_date = "";
  var end_date = "";

  var report_table = loadDatatable(category, start_date, end_date);

  function loadDatatable(category, start_date, end_date) {
    var table = $('.dataTable').DataTable({
      pagingType: 'full_numbers',
      lengthChange: false,
      scrollX: true,
      retrieve: true,
      ajax: {
        url: '/get_stock',
        type: 'GET',
        data: {
          category: category,
          start_date: start_date,
          end_date: end_date
        }
      },
      columns: [
        { "data": "id" },
        { "data": "plant" },
        { "data": "plant2" },
        { "data": "plant3" },
        { "data": "retek_class" },
        { "data": "retek_subclass" },
        { "data": "season" },
        { "data": "ean_number" },
        { "data": "rfid_number" },
        { "data": "variant_size" },
        { "data": "style_code" },
        { "data": "st_loc" },
        { "data": "variant" },
        { "data": "mrp" },
        { "data": "soh_blocked_stock" },
        { "data": "soh_without_blocked_stock" },
        { "data": "soh_quantity" },
        { "data": "soh_value" },
        { "data": "status"}
      ],
      "columnDefs": [
        {
            "render": function (data, type, row, meta) {
              return meta.row + meta.settings._iDisplayStart + 1;
            },
            "targets": 0
        },
        {
            "render": function ( data, type, row ) {
              if(data == null) {
                return "Missed";
              } else if (data == "scanned") {
                return "Stock";
              } else {
                return "Sold";
              }
            },
            "targets": 18
        }
      ]
    });
    return table;
  }

  $('.input-daterange').datepicker({
    format: "dd/mm/yyyy"
  });

  $('#applyFilters').on('click', function() {
    category = $("#reportCategory").val();
    start_date = $("#reportStartDate").val();
    end_date = $("#reportEndDate").val();

    if ((category == "") && (start_date == "") && (end_date == "")) {
      toastr.error("Please select any filter.");
    } else {
      var reportTable = report_table;
      $.ajax({
        type:'get',
        url:'/get_stock',
        data: { authenticity_token: $('[name="csrf-token"]')[0].content, category: category,
        start_date: start_date,
        end_date: end_date },
        success: function(result) {
          if (result) {
            reportTable.clear().draw();
            reportTable.rows.add(result.data);
            reportTable.columns.adjust().draw();
          }
        },
        failure: function(e) {
          console.log(e);
        }
      });
    }
  })

  $('#exportData').on('click', function() {
    var category = $("#reportCategory").val();
    var start_date = $("#reportStartDate").val();
    var end_date = $("#reportEndDate").val();
    toastr.success("Report downloaded successfully");
    window.location = "/download_report?category=" + category + "&start_date=" + start_date + "&end_date=" + end_date;
  });
})
</script>